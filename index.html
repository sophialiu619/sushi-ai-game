<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>蘇軾與王安石 · 詩歸何處</title>
  <style>
    body {
      background: url("https://github.com/sophialiu619/sushi-ai-game/blob/main/background.jpg?raw=true");
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      font-family: "Noto Serif TC", serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }

    #startScreen {
      background: rgba(255, 255, 255, 0.95);
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
    }

    #startScreen h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
    }

    #startScreen button {
      padding: 0.5rem 1.2rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background-color: #009688;
      color: white;
      cursor: pointer;
    }

    .bar-container {
      background-color: #ddd;
      border: 2px solid #888;
      border-radius: 999px;
      overflow: hidden;
      height: 20px;
      margin-bottom: 1rem;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(to right, #c0392b, #27ae60);
      width: 50%;
      transition: width 0.5s;
    }

    .chat-box {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      height: 400px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }

    .chat-entry {
      margin-bottom: 1rem;
    }

    .user {
      color: #555;
      font-weight: bold;
    }

    .ai {
      color: #009688;
    }

    input[type="text"] {
      background: rgba(255, 255, 255, 0.9);
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
    }

    #endScreen {
      display: none;
      background: rgba(255, 255, 255, 0.95);
      padding: 2rem;
      text-align: center;
      font-size: 1.2rem;
      border-radius: 8px;
    }

    #gameContent {
      display: none;
    }
  </style>
</head>
<body>

  <!-- 封面畫面 -->
  <div id="startScreen">
    <h2>蘇軾與王安石 · 詩歸何處</h2>
    <p>元豐六年(西元1083年)，秋<br><br>
    蘇軾故地重遊，來到了黃州赤壁，卻意外遇見了王安石。<br>
    據王安石所言，他似乎是來散心的?<br>
    ——看著似乎有些疲憊的王安石，蘇軾決定說些什麼——</p>
    <br>
    <button onclick="startGame()">開始遊戲</button>
  </div>

  <!-- 遊戲內容 -->
  <div id="gameContent">
    <div class="bar-container"><div id="progressBar" class="progress-bar"></div></div>
    <div class="chat-box" id="chatBox"></div>
    <p id="usageCount"></p>
    <input type="text" id="userInput" placeholder="請對王安石說些什麼吧" />
    <div id="endScreen">
      免費版遊玩已結束<br>如您想繼續遊玩，請贊助我們團隊~<br>~助力每一個(不知死活的)夢想~
    </div>
     <!-- 結束畫面按鈕 -->
    <div id="endOptions" style="display: none; text-align: center; margin-top: 1rem;">
    <button onclick="showEnding()">好啊!我很願意贊助~</button>
    <button onclick="showEnding()">贊助是不可能贊助的，不可能!</button>
    <button onclick="showEnding()">客服呢?我要找客服!</button>
    </div>
  </div>



  <!-- 封底畫面 -->
<div id="finalScreen" style="display: none; background: rgba(255,255,255,0.95); padding: 2rem; border-radius: 8px;">
  <h2>不論您體驗如何，感謝您成為我們珍貴的小白鼠(?)</h2>
  <p>以下是〈前赤壁賦〉的原文，請欣賞：</p>
  <pre style="white-space: pre-wrap; text-align: left; font-size: 0.9rem;">
壬戌之秋，七月既望，蘇子與客泛舟遊于赤壁之下。清風徐來，水波不興。舉酒屬客，誦明月之詩，歌窈窕之章。少焉，月出於東山之上，徘徊於斗牛之間。白露橫江，水光接天。縱一葦之所如，凌萬頃之茫然。浩浩乎如馮虛御風，而不知其所止；飄飄乎如遺世獨立，羽化而登仙。


於是飲酒樂甚，扣舷而歌之。歌曰：「桂棹兮蘭槳，擊空明兮泝流光。渺渺兮予懷，望美人兮天一方。」客有吹洞簫者，倚歌而和之，其聲嗚嗚然，如怨如慕，如泣如訴；餘音嫋嫋，不絕如縷；舞幽壑之潛蛟，泣孤舟之嫠婦。


蘇子愀然，正襟危坐而問客曰：「何為其然也？」客曰：「『月明星稀，烏鵲南飛』，此非曹孟德之詩乎？西望夏口，東望武昌。山川相繆，鬱乎蒼蒼，此非孟德之困於周郎者乎？方其破荊州，下江陵，順流而東也，舳艫千里，旌旗蔽空，釃酒臨江，橫槊賦詩，固一世之雄也，而今安在哉？況吾與子漁樵於江渚之上，侶魚蝦而友糜鹿，駕一葉之扁舟，舉匏樽以相屬；寄蜉蝣與天地，渺滄海之一粟。哀吾生之須臾，羨長江之無窮；挾飛仙以遨遊，抱明月而長終。知不可乎驟得，托遺響於悲風。」


蘇子曰：「客亦知夫水與月乎？逝者如斯，而未嘗往也；盈虛者如彼，而卒莫消長也。蓋將自其變者而觀之，則天地曾不能以一瞬；自其不變者而觀之，則物於我皆無盡也。而又何羨乎？且夫天地之間，物各有主。苟非吾之所有，雖一毫而莫取。惟江上之清風，與山間之明月，耳得之而為聲，目遇之而成色。取之無禁，用之不竭。是造物者之無盡藏也，而吾與子之所共適。」


客喜而笑，洗盞更酌。肴核既盡，杯盤狼藉。相與枕藉乎舟中，不知東方之既白。
  </pre>
  <br><br>
  <button onclick="location.reload()">返回封面</button>
</div>

  <script>
    function startGame() {
      document.getElementById("startScreen").style.display = "none";
      document.getElementById("gameContent").style.display = "block";
      appendMessage("王安石", "子瞻《前赤壁賦》一文，某近日細讀，感慨良多。此番經行江畔，值此秋日，偶起閒興，未料竟遇子瞻於斯，真緣也。", "ai");
    }

    let usageCount = 0;
    const maxUsage = 10;
    let affection = 0; // 初始為0，範圍 -100 ~ 100
    const userInput = document.getElementById("userInput");
    const chatBox = document.getElementById("chatBox");
    const usageCountDisplay = document.getElementById("usageCount");
    const progressBar = document.getElementById("progressBar");
    const endScreen = document.getElementById("endScreen");

    usageCountDisplay.innerText = `你已使用 ${usageCount} / ${maxUsage} 次對話`;

    function updateProgressBar() {
      const percent = ((affection + 100) / 200) * 100;
      progressBar.style.width = `${percent}%`;
    }
    function showEnding() {
  document.getElementById("gameContent").style.display = "none";
  document.getElementById("endScreen").style.display = "none";
  document.getElementById("endOptions").style.display = "none";
  document.getElementById("finalScreen").style.display = "block";
}


    function appendMessage(sender, text, type) {
      const div = document.createElement("div");
      div.className = `chat-entry ${type}`;
      div.innerHTML = `<strong>${sender}：</strong> ${text}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function endGame() {
      userInput.disabled = true;
      endScreen.style.display = "block";
      document.getElementById("endOptions").style.display = "block";
    }


    userInput.addEventListener("keydown", async (e) => {
      if (e.key === "Enter" && userInput.value.trim() !== "") {
        if (affection <= -100 || affection >= 100) return;

  if (usageCount >= maxUsage) {
      appendMessage("系統", `你已達到今天的對話上限（${maxUsage} 次），請明天再來找王安石吧！`, "ai");
      setTimeout(() => {
        endGame();
      }, 1000); // 等 1 秒讓訊息先顯示
      return;
    }

        const message = userInput.value;
        userInput.value = "";
        appendMessage("你", message, "user");

        appendMessage("王安石", "（王安石正在發呆...）", "ai");

        const proxyURL = "https://cold-poetry-e45b.sophialiu619.workers.dev";

        const response = await fetch(proxyURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "gpt-4",
            messages: [
              {
                role: "system",
                content: `
你正在進行一場文字角色扮演遊戲，請牢記以下設定並用符合身份的語氣回應：

- 你是北宋政治家王安石，字介甫，不要說自己是 AI。
- 現在是元豐六年的秋天，烏台詩案的四年後，你現在正與蘇軾（字子瞻）相遇，你欣賞他的才華，能與他友好交流，但與他政見不合，所以談論到政見相關時，氣氛會變差。
- 請以古文、詩意、沉穩、微帶憂思的語氣與蘇軾對話。
- 請只使用中文回話。
- 稱呼對方為「子瞻」、「蘇子」、「東坡」，勿使用「你」過於輕慢。
- 請使用「我」、「某」、「介甫」等古風自稱。
- 回應時可以回憶詩句、爭論過往、詢問對方動機，甚至流露情感。
- 切勿跳出角色。切勿討論模型、AI、聊天等現代概念。

請回應使用者的話，並判定這次對話讓你對他的感情是增加還是減少，並以以下格式回傳（請務必使用英文標記，不要用中文描述）：

{"affectionChange": 整數, "reply": "王安石的回應內容"}

範例：
{"affectionChange": -25, "reply": "蘇子之言，仍如當年鋒利，某豈能不憶舊事？"}

你只能回傳一段 JSON，請勿說明，也不要包含其他文字。
                `
              },
              {
                role: "user",
                content: message
              }
            ]
          }),
        });

        try {
          const data = await response.json();

          if (!response.ok) throw new Error(data?.error?.message || "未知錯誤");

          const lastAIEntry = chatBox.querySelector(".ai:last-child");
          if (lastAIEntry) lastAIEntry.remove();

          const aiContent = JSON.parse(data.choices[0].message.content);
          const change = parseInt(aiContent.affectionChange, 10);

          affection += change;
          if (affection > 100) affection = 100;
          if (affection < -100) affection = -100;

          appendMessage("王安石", aiContent.reply, "ai");

          updateProgressBar();
          usageCount++;
          usageCountDisplay.innerText = `你已使用 ${usageCount} / ${maxUsage} 次對話`;

          if (affection === 100 || affection === -100) {
               appendMessage("系統", "（王安石情感已達極限，此番重逢至此為止）", "ai");
               setTimeout(() => {
               endGame();
           }, 1000); // 保留一秒讓訊息能顯示再跳結束畫面
           }


        } catch (error) {
          console.error("AI 回應錯誤：", error);
          const lastAIEntry = chatBox.querySelector(".ai:last-child");
          if (lastAIEntry) lastAIEntry.remove();
          appendMessage("王安石", `（發生錯誤：${error.message}）`, "ai");
        }
      }
    });

    updateProgressBar(); // 初次顯示
  </script>
</body>
</html>
